<!DOCTYPE html>
<html>
<head>
<title>Master-Detail Demo in plain JavaScript</title>
<script data-main="../../../dolphin/opendolphin.js" src="../../../libs/require.js"></script>
<link href="../../../css/bootstrap.min.css" rel="stylesheet">
<link href="teammember.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
    <div class="col-lg-8">
        <button id="add-teammember" class="btn btn-default btn-sm button-add" title="add a row for a new team member"> + </button>
        <table id="list" class="table table-bordered table-condensed">
            <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Function</th>
                <th>Available</th>
                <th>Contractor</th>
                <th>Workload&nbsp;(%)</th>
                <th>Delete</th>
            </tr>
            </thead>
            <tbody id="team-records"></tbody>
        </table>
    </div>

    <div class="col-lg-4">
        <div id="teammember-form" class="detail-form unselected">
        <table style="margin: 20px;">
            <tr>
                <td align="right"><strong>First&nbsp;Name:</strong>&nbsp;</td>
                <td align="left"><input id="firstName" type="text"	placeholder="e.g. John" /></td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Last&nbsp;Name:</strong>&nbsp;</td>
                <td align="left"><input id="lastName" type="text"	placeholder="e.g. Doe" /></td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Function:</strong>&nbsp;</td>
                <td align="left"><select id="function">
                    <option value="" selected=""></option>
                    <option value="Engineer">Engineer</option>
                    <option value="Architect">Architect</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Consultant">Consultant</option>
                    <option value="CFO">CFO</option>
                    <option value="CTO">CTO</option>
                    <option value="CEO">CEO</option>
                </select></td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Available:</strong> &nbsp;</td>
                <td>
                    Yes
                    <input type="radio" id="availableYes" name="available" value="yes" />
                    &nbsp;No
                    <input type="radio"	id="availableNo" name="available" value="no"/>
                </td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Contractor: </strong> &nbsp; </td>
                <td> <input id="contractor" type="checkbox" value="true" /></td>
            </tr>
            <tr>
                <td/>
            </tr>
            <tr>
                <td align="right"><strong>Workload:</strong> &nbsp;</td>
                <td align="left"><input type="range" min="0" max="100" id="workLoad"/></td>
            </tr>
            <tr> <td/> </tr>
            <tr> <td/> </tr>
            <tr>
                <td ></td>
                <td >
                    <button id="save-button" disabled="true">Save</button>
                    <button id="reset-button"disabled="true">Reset</button>
                </td>
            </tr>
        </table>
    </div>
    </div>
</div>


<script>
    require([ 'opendolphin' ], function (dol) {

        // html elements to bind against
        var firstName           = document.getElementById("firstName");
        var lastName            = document.getElementById("lastName");
        var functionName        = document.getElementById("function");
        var availableYes        = document.getElementById("availableYes");
        var availableNo         = document.getElementById("availableNo");
        var isContractor        = document.getElementById("contractor");
        var workload            = document.getElementById("workLoad");
        var resetButton         = document.getElementById("reset-button");
        var saveTeamMemberBtn   = document.getElementById("save-button");
        var addTeamMemberBtn    = document.getElementById("add-teammember");
        var teamMemberForm      = document.getElementById("teammember-form");
        var table               = document.getElementById("team-records");

        // setting up the dolphin

        const SERVER_URL    = "http://localhost:8080/dolphin-grails/dolphin/";
        const PM_ID_MODEL   = "teamMemberMold";
        const PM_TYPE_MODEL = "teamMember";

        var dolphin         = dol.dolphin(SERVER_URL, true);

        // Create detail PM for stable binding of the detail view, representing the current selection
        var firstNameAttr       = dol.attribute("firstName",    null, "");
        var lastNameAttr        = dol.attribute("lastName",     null, "");
        var functionNameAttr    = dol.attribute("function",     null, "");
        var isAvailableAttr     = dol.attribute("available",    null, "");
        var isContractorAttr    = dol.attribute("contractor",   null, "");
        var workloadAttr        = dol.attribute("workLoad",     null, "");

        var detailPM            = dolphin.presentationModel(
                PM_ID_MODEL,
                PM_TYPE_MODEL,
                firstNameAttr, lastNameAttr, functionNameAttr, isAvailableAttr, isContractorAttr, workloadAttr
        );

        // there is no selection model for html tables, so we need to create one ourselves (client side only)
        var selectedRow    = dol.attribute("row",  null, -1);   /* -1 for no selection */
        var selectedPmId   = dol.attribute("pmId", null, null); /* null for no selection*/

        // whenever the selected presentation model changes, make sure we update the detail view
        selectedPmId.onValueChange(function(event) {
            var selectedPm = dolphin.getAt(event.newValue); // this may be null
            if (selectedPm) {
                teamMemberForm.className = "detail-form selected";
                detailPM.syncWith(selectedPm);
            } else {
                teamMemberForm.className = "detail-form unselected";
                // consider nulling-out the form, including qualifiers. syncWith(null) could do that.
            }
        });

        // send add command to create an empty pm
        addTeamMemberBtn.onclick = function () {
            dolphin.send("add");
        }
        // save the pm
        saveTeamMemberBtn.onclick = function () {
            dolphin.send("save");
        }
        // reset
        resetButton.onclick = function () {
            detailPM.reset();
        };

        // Register ModelStore change event to reflect newly available team members in the master view (table)
        dolphin.getClientModelStore().onModelStoreChange(function (modelStoreEvent) {
            if (modelStoreEvent.eventType == 'ADDED') {
                createTableRow(modelStoreEvent.clientPresentationModel);
            }
            if (modelStoreEvent.eventType == 'REMOVED') {
                removeTableRow(modelStoreEvent.clientPresentationModel);
            }
        });

        //Create table row
        var createTableRow = function (model) {
            var row = document.createElement("tr");
            row.dataset.id = model.id;
            // whenever the selected model changes, make sure we update the row accordingly
            selectedPmId.onValueChange(function() {
               row.id = ( selectedRow.getValue() == (row.rowIndex - 1) ? "selected-row" : "");
            });
            model.onDirty( function(event) {
                row.className = (event.newValue ? "dirty" : "clean");
            });
            row.addEventListener("click", function (event) {
                if (event.target.name == "delete-button") return; // clicking a button also counts as clicking on the row
                selectRow(row.rowIndex - 1); // row indexes start at 1
            });

            row.appendChild(createSelfUpdatingTDs(model,"firstName"));
            row.appendChild(createSelfUpdatingTDs(model,"lastName"));
            row.appendChild(createSelfUpdatingTDs(model,"function"));
            row.appendChild(createSelfUpdatingTDs(model,"available"));
            row.appendChild(createSelfUpdatingTDs(model,"contractor"));
            row.appendChild(createSelfUpdatingTDs(model,"workLoad"));
            row.appendChild(appendDeleteButton(model.id));
            table.appendChild(row);
            // right after creation, select the newly created row
            selectRow(row.rowIndex - 1); // row indexes start at 1
        };

        // find the tr of the to-be-removed model, remove it, and set the selection to the trailer if possible or one up otherwise
        var removeTableRow = function (model) {
            var found = -1;
            for (i=0; found < 0 && i < table.children.length; i++) {
                if (table.children[i].dataset.id == model.id) { found = i};
            }
            if (found < 0) { return; } // should never happen, but better be safe than sorry
            table.deleteRow(found);
            selectRow((table.children.length > found) ? found : found - 1 );
        }

        var selectRow = function(rowNumber) { // starting at 0
            selectedRow.setValue(rowNumber);
            var row  = table.children[rowNumber];
            var pmId = (row ? row.dataset.id : null);
            selectedPmId.setValue(pmId);
        }

        function createSelfUpdatingTDs(model, propertyName) {
            var attribute = model.findAttributeByPropertyName(propertyName)
            var td = document.createElement("td");
            td.dataset.role = attribute.propertyName;
            attribute.onValueChange(function (event) {
                td.innerHTML = event.newValue;
            });
            attribute.onDirty( function(event) {
                td.className = (event.newValue ? "dirty-field" : "clean");
            });
            return td
        }

        function appendDeleteButton(modelId) {
            var td   = document.createElement("td");
            var btn  = document.createElement("button");
            btn.id   = modelId;
            btn.name = 'delete-button';
            btn.className = 'btn btn-default btn-xs'
            btn.innerHTML = '&nbsp;-&nbsp;'
            btn.onclick   = function() {
                dolphin.deletePresentationModel(dolphin.findPresentationModelById(modelId))
            }
            td.align = 'center';
            td.appendChild(btn);
            return td
        }

        // bind firstName textfield to firstNameAttr bidirectional
        firstName.oninput = function (event) {
            firstNameAttr.setValue(firstName.value);
        };
        firstNameAttr.onValueChange(function (event) {
            firstName.value = event.newValue;
        });
        // bind lastName textfield to lastNameAttr bidirectional
        lastName.oninput = function (event) {
            lastNameAttr.setValue(lastName.value);
        };
        lastNameAttr.onValueChange(function (event) {
            lastName.value = event.newValue;
        });
        // bind functionName combobox to functionNameAttr bidirectional
        functionName.onclick = function (event) {
            functionNameAttr.setValue(functionName.value);
        };
        functionNameAttr.onValueChange(function (event) {
            functionName.value = event.newValue;
        });
        // availableYes binding with isAvailableAttr
        availableYes.onclick = function (event) {
            isAvailableAttr.setValue(availableYes.value);
        };
        // availableNo binding with isAvailableAttr
        availableNo.onclick = function (event) {
            isAvailableAttr.setValue(availableNo.value);
        };
        isAvailableAttr.onValueChange(function (event) {
            if (event.newValue == 'yes') {
                availableYes.checked = true;
            } else if (event.newValue == 'no') {
                availableNo.checked = true;
            } else {
                availableYes.checked = false;
                availableNo.checked = false;
            }
        });
        // isContractor binding with isContractorAttr
        isContractor.onclick = function (event) {
            isContractorAttr.setValue(isContractor.checked);
        };
        isContractorAttr.onValueChange(function (event) {
            isContractor.checked = event.newValue;
        });
        // workload binding with workloadAttr
        workload.onchange = function (event) {
            workloadAttr.setValue(workload.value);
        };
        workloadAttr.onValueChange(function (event) {
            workload.value = event.newValue;
        });

        // enable save button only if detail PM is dirty
        detailPM.onDirty(function (event) {
            saveTeamMemberBtn.disabled = !event.newValue;
        });

        // enable reset button only if detail PM is dirty
        detailPM.onDirty(function (event) {
            resetButton.disabled = !event.newValue;
        });

        // bind the pm's dirty state to the detail view style class
        detailPM.onDirty( function(event) {
            teamMemberForm.className = "detail-form selected " + (event.newValue ? "dirty" : "clean");
        });

    });
</script>

</body>
</html>