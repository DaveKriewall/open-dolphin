<!DOCTYPE html>
<html>
<head>
<title>Master-Detail Demo in plain JavaScript</title>
<script data-main="../../../dolphin/opendolphin.js" src="../../../libs/require.js"></script>
<link href="../../../css/bootstrap.min.css" rel="stylesheet">
<link href="teammember.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
    <div class="row">
    <div class="col-lg-8">
        <button id="add-teammember" class="btn btn-default btn-sm button-add" title="add a row for a new team member"> + </button>
        <table id="list" class="table table-bordered table-condensed">
            <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Function</th>
                <th>Available</th>
                <th>Contractor</th>
                <th>Workload&nbsp;(%)</th>
                <th>Delete</th>
            </tr>
            </thead>
            <tbody id="team-records"></tbody>
        </table>
    </div>

    <div class="col-lg-4">
        <div id="teammember-form" class="detail-form unselected">
        <table style="margin: 20px;">
            <tr>
                <td align="right"><strong>First&nbsp;Name:</strong>&nbsp;</td>
                <td align="left"><input id="firstName" type="text"	placeholder="e.g. John" maxlength="20"/></td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Last&nbsp;Name:</strong>&nbsp;</td>
                <td align="left"><input id="lastName" type="text"	placeholder="e.g. Doe" maxlength="20"/></td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Function:</strong>&nbsp;</td>
                <td align="left"><select id="function">
                    <option value="" selected=""></option>
                    <option value="Engineer">Engineer</option>
                    <option value="Architect">Architect</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Consultant">Consultant</option>
                    <option value="CFO">CFO</option>
                    <option value="CTO">CTO</option>
                    <option value="CEO">CEO</option>
                </select></td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Available:</strong> &nbsp;</td>
                <td>
                    Yes
                    <input type="radio" id="availableYes" name="available" value="yes" />
                    &nbsp;No
                    <input type="radio"	id="availableNo" name="available" value="no"/>
                </td>
            </tr>
            <tr>
                <td />
            </tr>
            <tr>
                <td align="right"><strong>Contractor: </strong> &nbsp; </td>
                <td> <input id="contractor" type="checkbox" value="true" /></td>
            </tr>
            <tr>
                <td/>
            </tr>
            <tr>
                <td align="right"><strong>Workload:</strong> &nbsp;</td>
                <td align="left"><input type="range" min="0" max="100" id="workLoad"/></td>
            </tr>
            <tr> <td/> </tr>
            <tr> <td/> </tr>
            <tr>
                <td ></td>
                <td >
                    <button id="save-button" disabled="true">Save</button>
                    <button id="reset-button"disabled="true">Reset</button>
                </td>
            </tr>
        </table>
    </div>
    </div>
    </div>
    <div class="row">
    <div class="col-lg-12">
        <hr>
        <a href="https://github.com/canoo/open-dolphin/blob/master/dolphin-grails/web-app/demo/js/teammember/TeamMemberDetails.html">source code</a>
    </div>
    </div>
</div>

<script>
    require([ 'opendolphin' ], function (dol) {

        // html elements to bind against
        var firstName           = document.getElementById("firstName");
        var lastName            = document.getElementById("lastName");
        var functionName        = document.getElementById("function");
        var availableYes        = document.getElementById("availableYes");
        var availableNo         = document.getElementById("availableNo");
        var isContractor        = document.getElementById("contractor");
        var workload            = document.getElementById("workLoad");
        var resetButton         = document.getElementById("reset-button");
        var saveTeamMemberBtn   = document.getElementById("save-button");
        var addTeamMemberBtn    = document.getElementById("add-teammember");
        var teamMemberForm      = document.getElementById("teammember-form");
        var table               = document.getElementById("team-records");

        // setting up the dolphin

        const SERVER_URL    = "http://localhost:8080/dolphin-grails/dolphin/";
        const PM_ID_MODEL   = "teamMemberMold";
        const PM_TYPE_N0    = null;

        var dolphin         = dol.dolphin(SERVER_URL, true);

        // Create detail PM for stable binding of the detail view, representing the current selection
        var firstNameAttr       = dolphin.attribute("firstName",    null, "");
        var lastNameAttr        = dolphin.attribute("lastName",     null, "");
        var functionNameAttr    = dolphin.attribute("function",     null, "");
        var isAvailableAttr     = dolphin.attribute("available",    null, false);
        var isContractorAttr    = dolphin.attribute("contractor",   null, false);
        var workloadAttr        = dolphin.attribute("workLoad",     null, 0);

        var detailPM            = dolphin.presentationModel( PM_ID_MODEL, PM_TYPE_N0,
            firstNameAttr, lastNameAttr, functionNameAttr, isAvailableAttr, isContractorAttr, workloadAttr
        );
        var blankPM = detailPM.copy(); // stored for later use on "unselect"

        var selectedPmId        = dolphin.attribute("selectedPmId", 'teammember.selected.id', null); /* null for no selection*/
        var selectedTeamMember  = dolphin.presentationModel("selectedTeamMember", null, selectedPmId);

        var disabledAttr        = dolphin.attribute("disabled", null, true); // a free-standing attribute for the detail form


        //////////////// binding to selection changes ////////////////

        // whenever the selected presentation model changes, make sure we update the detail view
        selectedPmId.onValueChange(function(event) {
            var selectedPm = dolphin.getAt(event.newValue);
            if (selectedPm) {
                disabledAttr.setValue(false);
                detailPM.syncWith(selectedPm);
            } else {
                detailPM.syncWith(blankPM);
                disabledAttr.setValue(true);
            }
        });

        // only when the detail PM _changes_ the enabled state, the style of the detail view needs update
        disabledAttr.onValueChange(function(evt) {
            teamMemberForm.className = "detail-form " + (evt.newValue ? "unselected" : "selected clean") ;
        });


        //////////////// registering button actions ///////////////////

        // send add command to create an empty pm
        addTeamMemberBtn.onclick = function () {
            dolphin.send("teamMember.add");
        }
        // save the pm
        saveTeamMemberBtn.onclick = function () {
            saveTeamMemberBtn.disabled = true;            // double-click protection
            disabledAttr.setValue(true);                  // no new inputs allowed while save is under way
            dolphin.send("teamMember.save", { onFinished: function() {
                disabledAttr.setValue(false);             // save is done, new input is allowed
            }});
        }
        // reset
        resetButton.onclick = function () {
            detailPM.reset();
        };


        //////////////// reacting to structural changes ///////////////////

        // Register ModelStore change event to reflect newly available team members in the master view (table)
        dolphin.getClientModelStore().onModelStoreChange(function (modelStoreEvent) {
            if (modelStoreEvent.eventType == 'ADDED') {
                createTableRow(modelStoreEvent.clientPresentationModel);
            }
            if (modelStoreEvent.eventType == 'REMOVED') {
                removeTableRow(modelStoreEvent.clientPresentationModel);
            }
        });

        // Table rows are a dynamic parts of the view. They need to be created or removed and bound.
        // Even though we create new bindings for the newly created views (TRs and TDs),
        // these bindings again remain stable throughout the whole program.

        var createTableRow = function (model) {
            var row = document.createElement("tr");
            row.dataset.id = model.id;
            // whenever the selection model changes, make sure we update the row accordingly
            selectedPmId.onValueChange(function(event) {
               row.id = ( model.id == event.newValue ? "selected-row" : "");
            });
            model.onDirty( function(event) {
                row.className = (event.newValue ? "dirty" : "clean");
            });
            row.addEventListener("click", function (event) {
                if (event.target.name == "delete-button") return; // clicking a button also counts as clicking on the row
                selectRow(row.rowIndex - 1); // row indexes start at 1
            });

            row.appendChild(createSelfUpdatingTDs(model,"firstName"));
            row.appendChild(createSelfUpdatingTDs(model,"lastName"));
            row.appendChild(createSelfUpdatingTDs(model,"function"));
            row.appendChild(createSelfUpdatingTDs(model,"available"));
            row.appendChild(createSelfUpdatingTDs(model,"contractor"));
            row.appendChild(createSelfUpdatingTDs(model,"workLoad"));
            row.appendChild(appendDeleteButton(model.id));
            table.appendChild(row);
            // right after creation, select the newly created row
            selectRow(row.rowIndex - 1); // row indexes start at 1
        };

        // find the tr of the to-be-removed model, remove it, and set the selection to the trailer if possible or one up otherwise
        var removeTableRow = function (model) {
            var found = -1;
            for (i=0; found < 0 && i < table.children.length; i++) {
                if (table.children[i].dataset.id == model.id) { found = i};
            }
            if (found < 0) { return; } // should never happen, but better be safe than sorry
            table.deleteRow(found);
            selectRow((table.children.length > found) ? found : found - 1 );
        }

        var selectRow = function(rowNumber) { // starting at 0
            var row  = table.children[rowNumber];
            var pmId = (row ? row.dataset.id : null);
            selectedPmId.setValue(pmId);
        }

        function createSelfUpdatingTDs(model, propertyName) {
            var attribute = model.findAttributeByPropertyName(propertyName)
            var td = document.createElement("td");
            td.dataset.role = attribute.propertyName;
            attribute.onValueChange(function (event) {
                td.innerHTML = event.newValue;
            });
            attribute.onDirty( function(event) {
                td.className = (event.newValue ? "dirty-field" : "clean");
            });
            return td
        }

        function appendDeleteButton(modelId) {
            var td   = document.createElement("td");
            var btn  = document.createElement("button");
            btn.id   = modelId;
            btn.name = 'delete-button';
            btn.className = 'btn btn-default btn-xs'
            btn.innerHTML = '&nbsp;-&nbsp;'
            btn.onclick   = function() {
                dolphin.deletePresentationModel(dolphin.findPresentationModelById(modelId))
            }
            td.align = 'center';
            td.appendChild(btn);
            return td
        }

        ///////////////////// simple stable bindings /////////////////////////

        // bind firstName textfield to firstNameAttr bidirectionally
        firstName.oninput = function (event) {
            firstNameAttr.setValue(firstName.value);
        };
        firstNameAttr.onValueChange(function (event) {
            firstName.value = event.newValue;
        });
        // bind lastName textfield to lastNameAttr bidirectionally
        lastName.oninput = function (event) {
            lastNameAttr.setValue(lastName.value);
        };
        lastNameAttr.onValueChange(function (event) {
            lastName.value = event.newValue;
        });
        // bind functionName combobox to functionNameAttr bidirectionally
        functionName.onchange = function (event) {
            functionNameAttr.setValue(functionName.value);
        };
        functionNameAttr.onValueChange(function (event) {
            functionName.value = event.newValue;
        });
        // availableYes/No binding with isAvailableAttr bidirectionally
        availableYes.onclick = function (event) {
            isAvailableAttr.setValue(availableYes.checked);
        };
        availableNo.onclick = function (event) {
            isAvailableAttr.setValue(availableYes.checked);
        };
        isAvailableAttr.onValueChange(function (event) {
            availableYes.checked =  event.newValue;
            availableNo.checked  = !event.newValue;
        });
        // isContractor binding with isContractorAttr bidirectionally
        isContractor.onclick = function (event) {
            isContractorAttr.setValue(isContractor.checked);
        };
        isContractorAttr.onValueChange(function (event) {
            isContractor.checked = event.newValue;
        });
        // workload binding with workloadAttr bidirectionally
        workload.onchange = function (event) {
            workloadAttr.setValue(workload.value);
        };
        workloadAttr.onValueChange(function (event) {
            workload.value = event.newValue;
        });

        // bind the disabled attribute to all input fields
        var detailFields = [firstName, lastName, functionName, availableYes, availableNo, isContractor, workload];
        detailFields.forEach(function(field) {
            disabledAttr.onValueChange(function(event){
                field.disabled = event.newValue;
            });
        });

        // enable save button only if detail PM is dirty
        detailPM.onDirty(function (event) {
            saveTeamMemberBtn.disabled = !event.newValue;
        });

        // enable reset button only if detail PM is dirty
        detailPM.onDirty(function (event) {
            resetButton.disabled = !event.newValue;
        });

        // bind the pm's dirty state to the detail view style class
        detailPM.onDirty( function(event) {
            teamMemberForm.className = "detail-form selected " + (event.newValue ? "dirty" : "clean");
        });

    });
</script>

</body>
</html>